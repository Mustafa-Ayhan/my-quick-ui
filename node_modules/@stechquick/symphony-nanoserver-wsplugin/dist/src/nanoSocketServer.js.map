{"version":3,"file":"nanoSocketServer.js","sourceRoot":"","sources":["../../src/nanoSocketServer.ts"],"names":[],"mappings":"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","sourcesContent":["import { Server } from \"http\";\nimport * as ws from \"ws\";\nimport { INanoServerPlugin } from \"@stechquick/symphony-nanoserver/dist/plugin/INanoServerPlugin\";\nimport { NanoSocket } from \"./nanoSocket\";\nimport { CreatePromiseData, IPromiseData } from \"@stechquick/symphony-common/lib/helpers/promiseData\";\nimport { INanoSocketRelayerOptions, NanoSocketRelayer } from \"./nanoSocketRelayer\";\n\ninterface INanoSocketServerOptions {\n    onClose?: () => void;\n    onConnection?: (source: NanoSocket) => void;\n    onError?: (error: Error) => void;\n}\n\nexport class NanoSocketServer implements INanoServerPlugin {\n    public PluginName: string = \"wsplugin\";\n    private wss?: ws.Server;\n    private idIndexedSockets: Record<string, NanoSocket>;\n    private options: INanoSocketServerOptions;\n    private attachPromise?: IPromiseData<{ result: boolean, reason?: string | undefined }>\n\n    constructor(options: INanoSocketServerOptions = {}) {\n        this.idIndexedSockets = {};\n        this.options = options;\n    }\n\n    public set onClose(cb: () => void) {\n        this.options.onClose = cb;\n    }\n    public set onConnection(cb: (source: NanoSocket) => void) {\n        this.options.onConnection = cb;\n    }\n    public set onError(cb: (error: Error) => void) {\n        this.options.onError = cb;\n    }\n\n    public Close() {\n        if (this.wss) {\n            const optionsBackup = this.options;\n            this.options = {};\n            this.wss.close();\n            this.wss.removeAllListeners();\n            this.options = optionsBackup;\n        }\n    }\n\n    public Attach(server: Server): void {\n        this.Close();\n        this.attachPromise = CreatePromiseData();\n        this.wss = new ws.Server({ server,  maxPayload: 500 * 1024 * 1024 });\n\n        this.wss.on(\"listening\", this.onSocketListening.bind(this));\n        this.wss.on(\"connection\", this.onSocketConnection.bind(this));\n        this.wss.on(\"error\", this.onSocketError.bind(this));\n        this.wss.on(\"close\", this.onSocketClose.bind(this));\n    }\n\n\n    public GetServerUrl() {\n        const address = this.wss?.address();\n        if (!address) { return undefined; }\n        if (typeof address == \"string\") { return address; }\n\n        const protocol = false ? \"wss\" : \"ws\";\n        const port = address?.port;\n        const logHost = address.address == \"0.0.0.0\" ? \"localhost\" : address.address;\n        return `${protocol}://${logHost}:${port}`;\n    }\n\n    public GetSocket(nanoSocketID: string): NanoSocket | undefined {\n        return this.idIndexedSockets[nanoSocketID];\n    }\n\n\n\n\n    private onSocketConnection(ws: ws) {\n        let cb: () => void | undefined;\n        const ns: NanoSocket = new NanoSocket(ws, { onClose: () => { delete this.idIndexedSockets[ns.ID]; cb?.(); } });\n        Object.defineProperty(ns, \"onClose\", { set: (value: () => void) => cb = value, configurable: true });\n        this.idIndexedSockets[ns.ID] = ns;\n        console.log(\"New socket conenction. Socket Id:\", ns.ID);\n        this.options?.onConnection?.(ns);\n    }\n\n    private onSocketClose() {\n        this.options?.onClose?.();\n    }\n    private onSocketError(error: Error) {\n        if (error.stack && error.stack.indexOf(\"EADDRINUSE\") > -1) { this.attachPromise!.resolver({ result: false }); return; }\n        this.options?.onError?.(error);\n    }\n    private onSocketListening() {\n        this.attachPromise!.resolver({ result: true });\n    }\n\n}"]}