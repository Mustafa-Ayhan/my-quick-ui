{"version":3,"file":"nanoSocket.js","sourceRoot":"","sources":["../../src/nanoSocket.ts"],"names":[],"mappings":"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","sourcesContent":["import { ClientRequest, IncomingMessage } from \"http\";\nimport * as ws from \"ws\";\nimport { ISocket, SocketDataType } from \"@stechquick/algae/lib/helpers/socket/iSocket\";\nimport { CryptoHelper } from \"@stechquick/symphony-common/lib/helpers/cryptoHelper\";\n\nexport interface INanoSocketOptions {\n    onMessage?: (message: SocketDataType) => void;\n    onClose?: () => void;\n};\n\nexport class NanoSocket implements ISocket {\n    private static nsCounter = 0;\n    private ws: ws;\n    private id: string;\n    private uid: string;\n    private options: INanoSocketOptions;\n\n    constructor(ws: ws, options: INanoSocketOptions = {}) {\n        this.options = options;\n        this.ws = ws;\n        this.ws.on(\"close\", this.onSocketClose.bind(this));\n        this.ws.on(\"message\", this.onSocketMessage.bind(this));\n        this.ws.on(\"error\", this.onSocketError.bind(this));\n        this.ws.on(\"open\", this.onSocketOpen.bind(this));\n        this.ws.on(\"ping\", this.onSocketPing.bind(this));\n        this.ws.on(\"pong\", this.onSocketPong.bind(this));\n        this.ws.on(\"unexpected-response\", this.onSocketUnexpectedResp.bind(this));\n        this.ws.on(\"upgrade\", this.onSocketUpgrade.bind(this));\n        this.id = \"NS\" + NanoSocket.nsCounter++;\n        this.uid = CryptoHelper.CreateGuid();\n    }\n\n\n    public set OnMessage(cb: ((message: SocketDataType) => void) | undefined) {\n        this.options.onMessage = cb;\n    }\n\n    public get OnMessage() {\n        return this.options.onMessage;\n    }\n\n    public set OnClose(cb: (() => void) | undefined) {\n        this.options.onClose = cb;\n    }\n    public get OnClose() {\n        return this.options.onClose;\n    }\n    public destroy(code?: number, reason?: string): void {\n        this.Close(code, reason);\n    }\n\n    public Send(message: object | string): void {\n        const data = message instanceof Object ? JSON.stringify(message) : message;\n        this.ws.send(data);\n        console.log(\"server --> \", data.length > 50 ? data.substring(0, 50) + \"... (\" + data.length + \")\" : data);\n    }\n\n    public Close(code?: number, reason?: string): void {\n        this.ws.close(code, reason);\n    }\n\n    public get ID(): string {\n        return this.id;\n    }\n\n    public get UID(): string {\n        return this.uid;\n    }\n\n\n\n\n    private async onSocketMessage(data: ws.Data) {\n        if (typeof data == \"string\") {\n            console.log(\"server <-- \", data.length > 50 ? data.substring(0, 50) + \"... (\" + data.length + \")\" : data);\n        } else if (data instanceof Buffer) {\n            console.log(\"server <-- ... (\" + data.length + \")\");\n        } else if (data instanceof Array) {\n            console.log(\"server <-- ... (\" + data.length + \")\");\n        } else {\n            console.log(\"server <-- ... (\" + data.byteLength + \")\");\n        }\n        this.options.onMessage?.(data);\n    }\n\n    private onSocketUnexpectedResp(req: ClientRequest, resp: IncomingMessage): void {\n        return console.log(\"client sent unexpResp: \");\n    }\n\n    private onSocketUpgrade(req: IncomingMessage): void {\n        return console.log(\"client sent upgrade\");\n    }\n\n    private onSocketPong(data: Buffer): void {\n        return console.log(\"Client sent pong. Client Id: \" + this.ID + \" Data: \" + data);\n    }\n\n    private onSocketPing(data: Buffer): void {\n        return console.log(\"client sent ping: \" + data);\n    }\n\n    private onSocketOpen() {\n        console.log(\"client connected: \" + this.ID);\n    }\n\n    private onSocketError(err: Error) {\n        console.log(\"client err \" + this.ID + \": \", err);\n    }\n\n    private onSocketClose(code: number, reason: string) {\n        this.ws.removeAllListeners();\n        this.options?.onClose?.();\n        console.log(\"client connection close: \" + this.ID + \" code: \", code, \"reason: \", reason);\n    }\n\n}"]}