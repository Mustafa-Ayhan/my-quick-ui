{"version":3,"file":"nanoSocketRelayer.js","sourceRoot":"","sources":["../../src/nanoSocketRelayer.ts"],"names":[],"mappings":"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","sourcesContent":["import { SocketDataType } from \"@stechquick/algae/lib/helpers/socket/iSocket\";\nimport * as ws from \"ws\";\nimport { NanoSocket } from \"./nanoSocket\";\n\ntype NSRelayerOnMessagesResponses = {\n    changeRelayMsg: {\n        type: \"changeRelayMsg\",\n        msg?: ws.Data,\n        destinationUIDs?: Array<string>,\n    },\n    noProcessNoRelay: {\n        type: \"noProcessNoRelay\",\n    },\n    processButNoRelay: {\n        type: \"processButNoRelay\",\n    },\n    continueRelay: {\n        type: \"continueRelay\",\n    },\n};\nexport interface INanoSocketRelayerOptions {\n    onMessage?: (senderType: \"source\" | \"target\", sender: NanoSocket, msg: SocketDataType) => NSRelayerOnMessagesResponses[keyof NSRelayerOnMessagesResponses] | undefined | null\n}\n\ninterface IRemoveTargetOptions {\n    /**\n     * message to be sent to target being removed\n     */\n    removeMessage?: string | object;\n}\ninterface IStopRelayOptions {\n    /**\n     * message to be sent to all clients while stopping relay\n     */\n    stopMessage?: string | object;\n}\n\ninterface ITargetOptions {\n    onClose?: () => void\n}\ninterface ITargetData {\n    ns: NanoSocket,\n    options?: ITargetOptions\n}\nexport class NanoSocketRelayer {\n    private source: NanoSocket;\n    private targets: Record<string, ITargetData | undefined>;\n    private options?: INanoSocketRelayerOptions;\n    private backup?: { sourceOnMessage: NanoSocket[\"OnMessage\"], targetOnMessages: Record<string, NanoSocket[\"OnMessage\"]> };\n\n    constructor(source: NanoSocket, options?: INanoSocketRelayerOptions) {\n        this.source = source;\n        this.targets = {};\n        this.options = options;\n    }\n\n    public StartRelay(): boolean {\n        if (this.backup) { return true; }\n\n        this.backup = { sourceOnMessage: this.source.OnMessage, targetOnMessages: {} };\n        this.source.OnMessage = message => this.relay(\"source\", this.source, message);\n        const targetUIDs = this.GetTargetUIDs();\n        targetUIDs.forEach(targetUID => this.backupAndConnect(this.targets[targetUID]!));\n        console.log(`[${this.source.UID}-${this.source.ID}] started as relay source to ${targetUIDs.length} targets`);\n        return true;\n    }\n\n    private backupAndConnect(target: ITargetData) {\n        this.backup!.targetOnMessages[target.ns.UID] = target.ns.OnMessage;\n        target.ns.OnMessage = message => this.relay(\"target\", target.ns, message);\n\n        const targetOnClose = target.ns.OnClose;\n        target.ns.OnClose = () => {\n            const options = target.options;\n            this.RemoveTarget(target.ns.UID, {});\n            target.ns.OnClose = targetOnClose;\n            targetOnClose?.();\n            options?.onClose?.();\n        };\n\n        console.log(`[${target.ns.UID}-${target.ns.ID}] started as relay target`);\n    }\n\n    public AddTarget(targetSocket: NanoSocket, options: ITargetOptions) {\n        if (!this.backup) {\n            this.StartRelay();\n        }\n        const target = this.targets[targetSocket.UID] = { ns: targetSocket, options };\n\n        if (!this.backup) { return; } // will connect\n\n        this.backupAndConnect(target);\n    }\n\n    public RemoveTarget(targetUID: string, options: IRemoveTargetOptions) {\n        const target = this.targets[targetUID];\n        if (!target) { return undefined; }\n\n        target.ns.OnMessage = this.backup!.targetOnMessages[targetUID];\n        if (options.removeMessage) {\n            target.ns.Send(options.removeMessage);\n        }\n\n        delete this.targets[targetUID];\n        delete this.backup!.targetOnMessages[targetUID];\n        delete target.options;\n        console.log(`[${target.ns.UID}-${target.ns.ID}] removed as relay target ${options.removeMessage ? \"- with removeMsg\" : \"\"}`);\n\n        return target;\n    }\n    public StopRelay(options: IStopRelayOptions): boolean {\n        if (!this.backup) { return true; }\n\n        this.source.OnMessage = this.backup.sourceOnMessage;\n        const targetUIDs = this.GetTargetUIDs();\n        targetUIDs.forEach(targetUID => this.RemoveTarget(targetUID, { removeMessage: options.stopMessage }));\n\n        console.log(`[${this.source.UID}-${this.source.ID}] stopped relay. Removed ${targetUIDs.length} targets ${options.stopMessage ? \"- with stopMsg\" : \"\"}`);\n        this.targets = {};\n        this.backup = undefined;\n        return true;\n    }\n\n    private relay(senderType: \"source\" | \"target\", sender: NanoSocket, message: SocketDataType) {\n        let relayMessage = message;\n        let relayOverride = this.options?.onMessage?.(senderType, sender, message);\n        let targettedRelayDestinationUIDs: Array<string> | undefined;\n\n        switch (relayOverride?.type) {\n            case \"changeRelayMsg\":\n                relayMessage = relayOverride.msg || relayMessage;\n                targettedRelayDestinationUIDs = this.filterTargets(relayOverride.destinationUIDs, senderType);\n                break;\n            case \"continueRelay\": break;\n            case \"processButNoRelay\": (senderType == \"source\" ? this.backup?.sourceOnMessage : this.backup?.targetOnMessages[sender.UID])?.(message); return;\n            case \"noProcessNoRelay\": return;\n        }\n\n\n        if (senderType == \"source\") {\n            const targetUIDs = targettedRelayDestinationUIDs ?? this.GetTargetUIDs();\n            targetUIDs.forEach(targetUID => this.targets[targetUID]!.ns.Send(relayMessage));\n            console.log(`[${this.source.UID}-${this.source.ID}] msg --> to ${targetUIDs.length} targets`);\n        } else {\n            this.source.Send(relayMessage);\n            console.log(`[${this.source.UID}-${this.source.ID}] msg <-- from target ${sender.UID}-${sender.ID}`);\n        }\n    }\n\n    private filterTargets(UIDs: Array<string> | undefined, senderType: \"source\" | \"target\") {\n        if (!UIDs) { return undefined; }\n        if (senderType == \"target\") { return UIDs; }\n\n        const filtered = UIDs.reduce((prev, UID) => {\n            const target = this.targets[UID] == undefined ? prev.invalids : prev.valids;\n            target.push(UID);\n            return prev;\n        }, { valids: [] as string[], invalids: [] as string[] })\n        if (filtered.invalids.length <= 0) { return UIDs; }\n        console.log(`[${this.source.UID}-${this.source.ID}] --> msg targets not found: `, filtered.invalids);\n        return filtered.valids;\n    }\n\n\n    public GetTargetUIDs() {\n        return Object.keys(this.targets);\n    }\n}"]}