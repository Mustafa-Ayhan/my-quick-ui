"use strict";
var http = require('http');
var https = require('https');
var log_on = false;
function log(msg) {
    if (!log_on) {
        return;
    }
    console.log(msg);
}
/**
 * Adds shutdown functionality to the `http.Server` object.
 * @param {http.Server} server The server to add shutdown functionality to.
 */
function addShutdown(server) {
    var connections = new Set(); // Use Set for better performance with large number of connections
    var isShuttingDown = false;
    var connectionCounter = 0;
    function destroy(socket, force) {
        if (force || (socket._isIdle && isShuttingDown)) {
            socket.destroy();
            connections.delete(socket);
        }
    }
    function onConnection(socket) {
        log("server on connection");
        var id = connectionCounter++;
        socket._isIdle = true;
        socket._connectionId = id;
        connections.add(socket); // Add socket to the Set
        socket.on('close', function () {
            log("socket close");
            connections.delete(socket); // Remove from Set when closed
        });
    }
    server.on('request', function (req, res) {
        log("server on request");
        req.socket._isIdle = false;
        res.on('finish', function () {
            log("response finish");
            req.socket._isIdle = true;
            destroy(req.socket);
        });
    });
    server.on('connection', onConnection);
    server.on('secureConnection', onConnection);
    function shutdown(force, cb) {
        log("shutdown");
        isShuttingDown = true;
        server.close(function (err) {
            if (cb) {
                process.nextTick(function () { cb(err); });
            }
        });
        connections.forEach(function (socket) { return destroy(socket, force); });
    }
    server.shutdown = function (force, cb) {
        shutdown(force, cb);
    };
    return server;
}
exports.addShutdown = addShutdown;
//# sourceMappingURL=gracefulShutdown.js.map