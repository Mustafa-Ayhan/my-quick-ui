{"version":3,"file":"NanoServer.js","sourceRoot":"","sources":["../../src/NanoServer.ts"],"names":[],"mappings":"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","sourcesContent":["import http from \"http\";\nimport https from \"https\";\nimport path from \"path\";\nimport fs from \"fs\";\nimport { INanoService, IServiceOptions } from \"./IService\";\nimport { NanoRequest } from \"./NanoRequest\";\nimport { NanoResponse } from \"./NanoResponse\";\nimport { RouteParser, IParsedPath, IMatchResult } from \"./RouteParser\";\nimport { FileHandler, IFileHandleResponse } from \"./fileHandler\";\nimport { UrlHelper } from \"./helpers/urlHelper\";\nimport { IsRelativePath } from \"./helpers/fileHelper\";\nimport { Proxy } from \"./helpers/httpHelper\";\nimport { addShutdown } from \"./gracefulShutdown\";\nimport { INanoServerPlugin } from \"../plugin/INanoServerPlugin\";\nimport { CorsManager, IManageCors } from \"@stechquick/symphony-common/lib/helpers/corsHelper\"\nimport { HttpMethods } from \"@stechquick/symphony-common/lib/interfaces/NetworkInterfaces/httpMethods\"\nimport { CreatePromiseData, IPromiseData } from \"@stechquick/symphony-common/lib/helpers/promiseData\";\nimport { NanoValidations } from \"./validation/nanoValidations\";\nimport { Pipeline } from \"./pipeline\";\n\ntype ILogCb = (logItem: { level: \"error\" | \"warn\" | \"info\" | \"log\" | \"debug\", message: string, error?: unknown, messageFunc?: () => string }) => void;\nconst defaults: INanoServerOptionsInternal = {\n    rootDiskPath: \"./\",\n    bindHost: \"0.0.0.0\",\n    statusCodeRedirects: {},\n    staticFileServing: \"on\",\n    backlog: 10,\n    logOverride: (item) => {\n        if (item.messageFunc) { item.message = item.messageFunc(); }\n        item.error ? console.error(item.message, item.error) : console.log(item.message)\n    },\n};\nconst noHostedPathDict: Record<string, boolean> = { \"/\": true, \"\": true };\n\nconst getHostName = (host: string) => {\n    switch(host) {\n        case defaults.bindHost: case \"::\": return \"localhost\";\n        default: return host;\n    }\n};\n\n\ninterface INanoServerStartOptions {\n    port: number;\n    successCb?: () => void;\n    errorCb?: (error: Error) => void;\n}\n\ninterface IServiceInternal extends INanoService {\n    routeParser: RouteParser\n}\n\ninterface IHttpsStartOptions extends INanoServerStartOptions {\n    privateKey?: string;\n    certificate?: string;\n}\n\nexport interface INanoServerOptions {\n    rootDiskPath?: string;\n    bindHost?: string;\n    statusCodeRedirects?: Record<number, undefined | ((request: http.IncomingMessage, path: IParsedPath, returning: IFileHandleResponse) => IFileHandleResponse | null | Promise<IFileHandleResponse>)>;\n    portSeekOffset?: number;\n    manageCors?: IManageCors;\n    staticFileServing?: \"on\" | \"off\";\n    hostedPath?: string;\n    backlog?: number;\n    logOverride?: ILogCb;\n};\n\nexport interface INanoServerOptionsInternal extends INanoServerOptions {\n    httpOptions?: INanoServerStartOptions;\n    httpsOptions?: IHttpsStartOptions;\n    rootDiskPath: string;\n    bindHost: string;\n    statusCodeRedirects: Record<number, undefined | ((request: http.IncomingMessage, path: IParsedPath, returning: IFileHandleResponse) => IFileHandleResponse | null | Promise<IFileHandleResponse>)>;\n    services?: Array<IServiceInternal>;\n    staticFileServing: \"on\" | \"off\";\n    hostedPath?: string;\n    backlog: number;\n    logOverride: ILogCb;\n};\n\nexport class NanoServer {\n    private server?: http.Server;\n    private options: INanoServerOptionsInternal;\n    private plugins: Array<INanoServerPlugin>;\n    private promDatas: { onStart?: IPromiseData<void> };\n    private portForcingTryCount = 0;\n\n    constructor(options?: INanoServerOptions) {\n        const newDef = Object.assign({}, defaults) as Record<string, any>;\n        if (options){\n            Object.keys(options).forEach(curKey => newDef[curKey] = (options as Record<string, any>)[curKey] ?? newDef[curKey]);\n        }\n        this.options = newDef as INanoServerOptionsInternal;\n        this.plugins = [];\n        this.promDatas = {};\n    }\n\n    public GetServerUrl(options: { protocol?: \"http\" | \"https\" } = {}): string | undefined {\n        if (!this.options.httpOptions && !this.options.httpsOptions) { return undefined; }\n\n        const protocol = options.protocol || (this.options.httpsOptions ? \"https\" : \"http\");\n\n        let targetOptions = this.options[protocol + \"Options\" as \"httpOptions\" | \"httpsOptions\"];\n        if (!targetOptions) { return undefined; }\n\n        const port = targetOptions.port;\n        \n        const logHost = getHostName(this.options.bindHost);\n        return `${protocol}://${logHost}:${port}`;\n    }\n\n    public Subscribe(options: { event: \"onStart\", cb: () => void }) {\n        const promData = this.promDatas[options.event] = this.promDatas[options.event] || CreatePromiseData();\n        promData.promise.then(options.cb);\n    }\n\n    public async Start(startingOptions: INanoServerStartOptions) {\n        this.options.logOverride({ level: \"log\", message: \"Starting http server...\" });\n        this.options.httpOptions = startingOptions;\n        const httpServer = http.createServer(this.handleRequest.bind(this));\n        this.StartNewServer(httpServer, startingOptions);\n    }\n\n    public async StartHttps(options: IHttpsStartOptions) {\n        this.options.logOverride({ level: \"log\", message: \"Starting https server...\" });\n        this.options.httpsOptions = options;\n        const httpsServer = https.createServer({ key: options.privateKey, cert: options.certificate }, this.handleRequest.bind(this));\n        this.StartNewServer(httpsServer, options);\n    }\n\n    private attachPlugin(plugin: INanoServerPlugin, server: http.Server) {\n        plugin.Attach(server);\n        this.options.logOverride({ level: \"debug\", message: \"plugin registered: \" + plugin.PluginName });\n    }\n\n    private async StartNewServer(server: http.Server | https.Server, startingOptions: INanoServerStartOptions) {\n        const optionsToLog = JSON.parse(JSON.stringify(this.options)) as INanoServerOptionsInternal;\n        delete optionsToLog.services;\n        this.options.logOverride({ level: \"debug\", message: \"\", messageFunc: () => \"NanoServer options: \" + JSON.stringify(optionsToLog) });\n        this.portForcingTryCount = 0;\n        addShutdown(server);\n\n        const tryIt = () => {\n            this.options.logOverride({ level: \"debug\", message: \"trying port: \" + startingOptions.port });\n            const backlog = this.options.backlog;\n            server.listen(startingOptions.port, this.options.bindHost, backlog, (() => {\n                this.options.logOverride({ level: \"debug\", message: \"found empty port: \" + startingOptions.port + \" listening backlog: \" + backlog });\n                this.options.logOverride({ level: \"debug\", message: \"NS plugins: \" + this.plugins.length });\n                this.plugins?.forEach(plugin => this.attachPlugin(plugin, server));\n                this.server = server;\n                this.promDatas.onStart?.resolver();\n                startingOptions?.successCb?.();\n            }));\n\n            server.on('error', (error: Error) => {\n                const isInUse = error.stack && error.stack?.indexOf(\"EADDRINUSE\") > 0;\n                if (isInUse && this.retryForNextPort()) {\n                    this.options.logOverride({ level: \"warn\", message: \"port in use: \" + startingOptions.port });\n                    startingOptions.port++;\n                    tryIt();\n                }\n                else {\n                    if (!startingOptions?.errorCb) {\n                        throw error;\n                    }\n                    startingOptions?.errorCb(error);\n                }\n            });\n        }\n\n        tryIt();\n    }\n\n    public Stop(options?: { callback?: (err?: Error) => void, force?: boolean }) {\n        if (!this.server) { return; }\n        options = options || {};\n        (<any>this.server).shutdown(options.force, options.callback);\n        this.server.close();\n        delete this.server;\n    }\n\n    public ClearServices() {\n        this.options.services = [];\n    }\n\n    public AddService(service: INanoService) {\n        const routeParser = new RouteParser(this.subtractHostedPath(service.PathStart));\n        this.options.services = this.options.services ?? [];\n        this.options.services.push(Object.assign(service, { routeParser }));\n    }\n\n    public AddPlugin(plugin: INanoServerPlugin): void {\n        this.plugins.push(plugin);\n        if (!this.server) { return; } // during start, plugins are also attached\n\n        this.attachPlugin(plugin, this.server);\n    }\n\n    public AddProxy(proxyOptions: Record<string, string>) {\n        const self = this;\n        Object.keys(proxyOptions).forEach(sourceUrl => {\n            const methods: Array<HttpMethods> = [\"DELETE\", \"GET\", \"OPTIONS\", \"POST\", \"PUT\"];\n            this.AddService({\n                PathStart: sourceUrl, Methods: new Set<HttpMethods>(methods), Execute: async (options) => {\n                    const proxyTarget = proxyOptions[sourceUrl];\n                    if (UrlHelper.IsDirectUrl(proxyTarget)) {\n                        // QJSON req -> /services/mui/api/v1/mui/organisation/8160477411\n\n                        // /services/mui: http://stech:80/ -> http://stech:80/api/v1/mui/organisation/8160477411\n                        // --------------------------------------------------------------------------------------------------------------------------\n                        // /services/mui: http://stech:80/services/mui -> http://stech:80/services/mui/api/v1/mui/organisation/8160477411\n                        // ---------------------------------------------------------------------------------------------------------------------------------------------\n                        // /services/mui: http://stech:80/seda/ -> http://stech:80/seda/api/v1/mui/organisation/8160477411\n                        // ---------------------------------------------------------------------------------------------------------------------------------------------\n                        // /services/mui/api: http://localhost:80/seda/ -> http://stech:80/seda/v1/mui/organisation/8160477411\n                        // ---------------------------------------------------------------------------------------------------------------------------------------------\n                        // /services/mui: {target: http://stech:80/, revwrite: {source:/organication, target: /alper }} -> http://stech:80/api/v1/mui/alper/8160477411  /// BU HENÜZ YOK\n\n                        ///services/mui/api/v1/mui/organisation/8160477411?x=5\n                        //services/mui/api/v1/mui/organisation/8160477411: http://google.com/alper/seda -> http://google.com/alper/seda?x=5\n\n                        // url.resolve -> query string yiyor + ilk parametrenin host'u join yapıyor\n                        // posix.join executes unix join based on single /, problem with \"http://\"\n                        const parsed = UrlHelper.DetachProtocol(proxyTarget);\n                        const protocolUrl = (parsed.protocol ? parsed.protocol + \"://\" : \"\");\n                        let targetUrl = protocolUrl + path.posix.join(parsed.pureUrl, options.request.matchLeftover || \"\") + (options.request.args ? \"?\" + options.request.args : \"\");\n\n                        const method = options.request.httpRequest.method;\n                        const headers = options.request.httpRequest.headers;\n                        if (headers.host) {\n                            delete headers.host;\n                            this.options.logOverride({ level: \"debug\", message: \"removed host header\" });\n                        }\n\n                        //TODO: for long requests with multiple large chunks, you should not get body, but transfer request handle to proxy instead of body, and connect client request callbacks to proxy requests. -> req.on(data => proxyReq.write(data)) and req.onend(() => proxyReq.end()) //56041\n                        const body = await options.request.GetBody();\n                        this.options.logOverride({ level: \"log\", message: `http redirect: ${sourceUrl} --> ${targetUrl}` });\n\n                        Proxy(options.response.httpResponse, targetUrl, { method, headers, body });\n                    } else {\n                        let targetUrl = proxyTarget;\n\n                        let targetPath = path.join(targetUrl, options.request.matchLeftover || \"\");\n                        if (IsRelativePath(targetUrl)) {\n                            targetPath = path.join(self.options.rootDiskPath, targetPath);\n                        }\n                        this.options.logOverride({ level: \"log\", message: `disk redirect: ${sourceUrl} --> ${targetPath}` });\n                        const parsedPath = RouteParser.ParseUrl(targetPath);\n                        const serviceOptions: IServiceOptions = { request: new NanoRequest(options.request.httpRequest, {}), response: new NanoResponse(options.response.httpResponse) };\n                        self.handleFileRequest(\"\", parsedPath, serviceOptions);\n                    }\n                }\n            });\n        });\n    }\n\n    // // where is this used ???\n    // public GetServedFileList(): string[] {\n    //     const getAllFiles = (dirPath: string, arrayOfFiles?: string[]) => {\n    //         const files = fs.readdirSync(dirPath)\n    //         arrayOfFiles = arrayOfFiles || [];\n\n    //         files.forEach((file) => {\n    //             if (fs.statSync(dirPath + \"/\" + file).isDirectory()) {\n    //                 arrayOfFiles = getAllFiles(dirPath + \"/\" + file, arrayOfFiles);\n    //             } else {\n    //                 const fullPath = path.join(dirPath, file);\n    //                 const item = this.GetServerUrl() + fullPath.replace(this.options.rootDiskPath, \"\").replace(/\\\\/gi, \"/\");\n    //                 arrayOfFiles!.push(item);\n    //             }\n    //         });\n    //         return arrayOfFiles\n    //     }\n    //     return getAllFiles(this.options.rootDiskPath);\n    // }\n\n    public GetOptions() {\n        const { bindHost, hostedPath, rootDiskPath, staticFileServing, portSeekOffset } = this.options;\n        let retVal = {\n            bindHost, hostedPath, rootDiskPath, staticFileServing, portSeekOffset,\n            httpPort: this.options.httpOptions?.port,\n            httpsPort: this.options.httpsOptions?.port\n        };\n        return retVal;\n    }\n\n    private retryForNextPort(): boolean {\n        const forcingCount = this.options.portSeekOffset;\n        if (forcingCount && forcingCount > this.portForcingTryCount) {\n            this.portForcingTryCount++;\n            return true;\n        }\n        return false;\n    }\n\n    private async handleRequest(request: http.IncomingMessage, response: http.ServerResponse): Promise<void> {\n        try {\n            await this.tryHandleRequest(request, response);\n        } catch (err) {\n            this.options.logOverride({ level: \"error\", message: \"Ex in request handing: \", error: err });\n\n            response.writeHead(500, { \"Content-Type\": \"text/html; charset=utf-8\", \"Content-Length\": 0 });\n            response.end();\n        }\n    }\n    private subtractHostedPath(url: string): string {\n        if (!this.options.hostedPath || noHostedPathDict[this.options.hostedPath] || !url.startsWith(this.options.hostedPath)) { return url; }\n\n        let hostedPathLength = this.options.hostedPath.length;\n        if (this.options.hostedPath[hostedPathLength - 1] == \"/\") {\n            hostedPathLength--;\n        }\n        return url.slice(hostedPathLength);\n    }\n    private async tryHandleRequest(request: http.IncomingMessage, response: http.ServerResponse): Promise<void> {\n        let url = request.url || \"\";\n        url = this.subtractHostedPath(url);\n        this.options.logOverride({ level: \"debug\", message: `->: ${url}` });\n\n        // response.on(\"finish\", () => request.destroy());\n\n        const parsedUrl = RouteParser.ParseUrl(url);\n        const serviceOptions: IServiceOptions = { request: new NanoRequest(request, {}), response: new NanoResponse(response) };\n\n        const validationResp = new NanoValidations().ValidateUrl(parsedUrl);\n        if (validationResp){\n            await new Pipeline().Respond(validationResp, serviceOptions, parsedUrl, this.options);\n            return;\n        }\n\n        //fix root\n        if (parsedUrl.dir == \"/\" && parsedUrl.base == \"\") {\n            parsedUrl.name = \"index\";\n            parsedUrl.ext = \".html\";\n            parsedUrl.base = parsedUrl.name + parsedUrl.ext;\n        }\n\n\n        if (await this.handleService(parsedUrl, serviceOptions)) {\n            return;\n        }\n\n        if (this.options.staticFileServing == \"on\" && await this.handleFileRequest(this.options.rootDiskPath, parsedUrl, serviceOptions, this.options.manageCors)) {\n            return;\n        }\n\n        const content = \"Service Unavailable: \" + url.substring(0, 50) + (url.length > 50 ? \"...\" : \"\");\n        const handleResponse: IFileHandleResponse = {\n            content, headers: { \"Content-Type\": \"text/html; charset=utf-8\", \"Content-Length\": content.length.toString() }, status: 503\n        };\n        let handleResponseOverride: IFileHandleResponse | null = await this.options.statusCodeRedirects[503]?.(serviceOptions.request.httpRequest, parsedUrl, handleResponse) || handleResponse;\n\n        this.options.logOverride({level: \"debug\", message: \"\", messageFunc: () => `<- ${handleResponse.status}`});\n        response.writeHead(handleResponseOverride.status, handleResponseOverride.headers);\n        response.end(handleResponseOverride.content, \"utf-8\");\n    }\n    private isBinaryFile(ext: string) {\n        const mimeTypes: Record<string, boolean | undefined> = {\n            '.html': false,\n            '.js': false,\n            '.css': false,\n            '.json': false,\n            '.png': true,\n            '.jpg': true,\n            '.gif': true,\n            '.wav': true,\n            '.mp4': true,\n            '.woff': true,\n            '.ttf': true,\n            '.eot': false,\n            '.otf': false,\n            '.svg': false,\n            \".dll\": false,\n            \".txt\": false,\n        }\n        return mimeTypes[ext]\n    }\n\n    private async handleFileRequest(basePath: string, parsedPath: IParsedPath, serviceOptions: IServiceOptions, manageCors?: IManageCors) {\n        if (manageCors) {\n            const method = <HttpMethods>serviceOptions.request.httpRequest.method;\n            const origin = serviceOptions.request.httpRequest.headers.origin;\n            const corsResp = CorsManager.ManageCors({ method, origin: origin ? [origin] : undefined }, manageCors);\n            if (!corsResp.success) {\n                const resp = serviceOptions.response.httpResponse;\n                resp.statusCode = corsResp.statusCode;\n                resp.end(corsResp.message);\n                return true;\n            }\n            serviceOptions.response.writeHeaders(corsResp.headers);\n        }\n        if (this.isBinaryFile(parsedPath.ext)) {\n            const filePath = path.resolve(path.join(basePath, parsedPath.dir, parsedPath.base));\n            var stream = fs.createReadStream(filePath);\n            stream.on('open', function () {\n\n                stream.pipe(serviceOptions.response.httpResponse);\n            });\n            const self = this;\n            stream.on('error', function (e) {\n                const status = 404;\n                self.options.logOverride({ level: \"error\", message: \"Image error:\", error: e });\n                self.options.logOverride({level: \"debug\", message: \"\", messageFunc: () => `<- ${status}`});\n                serviceOptions.response.httpResponse.setHeader('Content-Type', 'text/plain');\n                serviceOptions.response.httpResponse.statusCode = status;\n                serviceOptions.response.httpResponse.end('Not found');\n            });\n\n            return true\n        }\n\n        let fileResponse = new FileHandler().handleFileRequest(basePath, parsedPath);\n        const redirect = await this.options?.statusCodeRedirects[fileResponse.status]?.(serviceOptions.request.httpRequest, parsedPath, fileResponse);\n        if (redirect) {\n            fileResponse = redirect;\n            this.options.logOverride({ level: \"debug\", message: \"\", messageFunc: () => `custom redirect status: ${redirect.status} headers:` + JSON.stringify(redirect.headers || {}) });\n        }\n        this.options.logOverride({level: \"debug\", message: \"\", messageFunc: () => `<- ${fileResponse.status}`});\n        serviceOptions.response.httpResponse.writeHead(fileResponse.status, fileResponse.headers);\n        serviceOptions.response.httpResponse.end(fileResponse.content, \"utf-8\");\n        return true;\n    }\n\n    private async handleService(parsedUrl: IParsedPath, serviceOptions: IServiceOptions): Promise<boolean> {\n        let retVal = false;\n        const method = <HttpMethods>serviceOptions.request.httpRequest.method;\n        if (!this.options.services || !method) { return retVal; }\n\n        const initialObj: { result: IMatchResult, service?: IServiceInternal } = { result: { match: false, routeDict: {}, power: 0 } };\n\n        const matchResult = this.options.services.reduce((prev, service) => {\n            if (!service.Methods.has(method)) { return prev; }\n\n            const matchResult = service.routeParser.MatchAndGetRouteDict(parsedUrl);\n            if (!matchResult.match) { return prev; }\n\n            return matchResult.power > prev.result.power ? { service, result: matchResult } : prev;\n        }, initialObj);\n\n        if (matchResult.result.match) {\n            retVal = true;\n            serviceOptions.request.routeDict = matchResult.result.routeDict;\n            const matchData = matchResult.result.getMatchData?.();\n            serviceOptions.request.matchLeftover = matchData?.matchLeftOver;\n            serviceOptions.request.args = matchData?.args;\n            await matchResult.service!.Execute(serviceOptions);\n        }\n\n        return retVal;\n    }\n\n\n\n\n\n}"]}