{"version":3,"file":"gracefulShutdown.js","sourceRoot":"","sources":["../../src/gracefulShutdown.js"],"names":[],"mappings":";AAAA,IAAI,IAAI,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC;AAC3B,IAAI,KAAK,GAAG,OAAO,CAAC,OAAO,CAAC,CAAC;AAE7B,IAAI,MAAM,GAAG,KAAK,CAAC;AACnB,SAAS,GAAG,CAAC,GAAG;IACZ,IAAI,CAAC,MAAM,EAAE;QAAE,OAAO;KAAE;IACxB,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;AACrB,CAAC;AAED;;;GAGG;AACH,SAAS,WAAW,CAAC,MAAM;IACvB,IAAI,WAAW,GAAG,IAAI,GAAG,EAAE,CAAC,CAAE,kEAAkE;IAChG,IAAI,cAAc,GAAG,KAAK,CAAC;IAC3B,IAAI,iBAAiB,GAAG,CAAC,CAAC;IAE1B,SAAS,OAAO,CAAC,MAAM,EAAE,KAAK;QAC1B,IAAI,KAAK,IAAI,CAAC,MAAM,CAAC,OAAO,IAAI,cAAc,CAAC,EAAE;YAC7C,MAAM,CAAC,OAAO,EAAE,CAAC;YACjB,WAAW,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;SAC9B;IACL,CAAC;IAED,SAAS,YAAY,CAAC,MAAM;QACxB,GAAG,CAAC,sBAAsB,CAAC,CAAC;QAC5B,IAAI,EAAE,GAAG,iBAAiB,EAAE,CAAC;QAC7B,MAAM,CAAC,OAAO,GAAG,IAAI,CAAC;QACtB,MAAM,CAAC,aAAa,GAAG,EAAE,CAAC;QAC1B,WAAW,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAE,wBAAwB;QAElD,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE;YACf,GAAG,CAAC,cAAc,CAAC,CAAC;YACpB,WAAW,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAE,8BAA8B;QAC/D,CAAC,CAAC,CAAC;IACP,CAAC;IAED,MAAM,CAAC,EAAE,CAAC,SAAS,EAAE,UAAU,GAAG,EAAE,GAAG;QACnC,GAAG,CAAC,mBAAmB,CAAC,CAAC;QACzB,GAAG,CAAC,MAAM,CAAC,OAAO,GAAG,KAAK,CAAC;QAE3B,GAAG,CAAC,EAAE,CAAC,QAAQ,EAAE;YACb,GAAG,CAAC,iBAAiB,CAAC,CAAC;YACvB,GAAG,CAAC,MAAM,CAAC,OAAO,GAAG,IAAI,CAAC;YAC1B,OAAO,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QACxB,CAAC,CAAC,CAAC;IACP,CAAC,CAAC,CAAC;IAEH,MAAM,CAAC,EAAE,CAAC,YAAY,EAAE,YAAY,CAAC,CAAC;IACtC,MAAM,CAAC,EAAE,CAAC,kBAAkB,EAAE,YAAY,CAAC,CAAC;IAE5C,SAAS,QAAQ,CAAC,KAAK,EAAE,EAAE;QACvB,GAAG,CAAC,UAAU,CAAC,CAAC;QAChB,cAAc,GAAG,IAAI,CAAC;QACtB,MAAM,CAAC,KAAK,CAAC,UAAU,GAAG;YACtB,IAAI,EAAE,EAAE;gBACJ,OAAO,CAAC,QAAQ,CAAC,cAAc,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;aAC9C;QACL,CAAC,CAAC,CAAC;QAEH,WAAW,CAAC,OAAO,CAAC,UAAC,MAAM,IAAK,OAAA,OAAO,CAAC,MAAM,EAAE,KAAK,CAAC,EAAtB,CAAsB,CAAC,CAAC;IAC5D,CAAC;IAED,MAAM,CAAC,QAAQ,GAAG,UAAU,KAAK,EAAE,EAAE;QACjC,QAAQ,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;IACxB,CAAC,CAAC;IAEF,OAAO,MAAM,CAAC;AAClB,CAAC;AAED,OAAO,CAAC,WAAW,GAAG,WAAW,CAAC","sourcesContent":["var http = require('http');\nvar https = require('https');\n\nvar log_on = false;\nfunction log(msg) {\n    if (!log_on) { return; }\n    console.log(msg);\n}\n\n/**\n * Adds shutdown functionality to the `http.Server` object.\n * @param {http.Server} server The server to add shutdown functionality to.\n */\nfunction addShutdown(server) {\n    var connections = new Set();  // Use Set for better performance with large number of connections\n    var isShuttingDown = false;\n    var connectionCounter = 0;\n\n    function destroy(socket, force) {\n        if (force || (socket._isIdle && isShuttingDown)) {\n            socket.destroy();\n            connections.delete(socket);\n        }\n    }\n\n    function onConnection(socket) {\n        log(\"server on connection\");\n        var id = connectionCounter++;\n        socket._isIdle = true;\n        socket._connectionId = id;\n        connections.add(socket);  // Add socket to the Set\n\n        socket.on('close', function () {\n            log(\"socket close\");\n            connections.delete(socket);  // Remove from Set when closed\n        });\n    }\n\n    server.on('request', function (req, res) {\n        log(\"server on request\");\n        req.socket._isIdle = false;\n\n        res.on('finish', function () {\n            log(\"response finish\");\n            req.socket._isIdle = true;\n            destroy(req.socket);\n        });\n    });\n\n    server.on('connection', onConnection);\n    server.on('secureConnection', onConnection);\n\n    function shutdown(force, cb) {\n        log(\"shutdown\");\n        isShuttingDown = true;\n        server.close(function (err) {\n            if (cb) {\n                process.nextTick(function () { cb(err); });\n            }\n        });\n\n        connections.forEach((socket) => destroy(socket, force));\n    }\n\n    server.shutdown = function (force, cb) {\n        shutdown(force, cb);\n    };\n\n    return server;\n}\n\nexports.addShutdown = addShutdown;"]}