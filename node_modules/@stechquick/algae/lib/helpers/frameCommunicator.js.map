{"version":3,"file":"frameCommunicator.js","sourceRoot":"","sources":["../../src/helpers/frameCommunicator.ts"],"names":[],"mappings":";;;AACA,8DAAwG;AAExG;IAKI,sBAAY,YAAoB;QAAhC,iBAQC;QAZM,8BAAyB,GAAG,IAAI,CAAC;QAKpC,IAAI,CAAC,YAAY,GAAG,YAAY,CAAC;QACjC,MAAM,CAAC,gBAAgB,CAAC,SAAS,EAAE,IAAI,CAAC,cAAc,GAAG,UAAC,EAAE;;YACxD,IAAI,EAAE,CAAC,MAAM,IAAS,YAAY,EAAE;gBAChC,OAAO;aACV;YACD,MAAA,KAAI,CAAC,SAAS,+CAAd,KAAI,EAAa,EAAE,CAAC,IAAI,CAAC,CAAC;QAC9B,CAAC,CAAC,CAAA;IACN,CAAC;IACD,2BAAI,GAAJ,UAAK,MAAuB;QACxB,IAAI,CAAC,YAAY,CAAC,WAAW,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC;IAC/C,CAAC;IAEM,8BAAO,GAAd;QACI,MAAM,CAAC,mBAAmB,CAAC,SAAS,EAAE,IAAI,CAAC,cAAc,CAAC,CAAC;QAC3D,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC;IAC/B,CAAC;IACL,mBAAC;AAAD,CAAC,AAtBD,IAsBC;AAaD;IAGI,2BAAY,YAAoB;QAC5B,IAAI,CAAC,YAAY,GAAG,IAAI,YAAY,CAAC,YAAY,CAAC,CAAC;QACnD,IAAI,CAAC,gBAAgB,GAAG,IAAI,mCAAgB,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;IACpE,CAAC;IACM,gCAAI,GAAX,UAAqF,MAAe,EAAE,WAAoB,EAAE,OAAmC,EAAE,OAAyC;QACtM,IAAM,gBAAgB,GAAI,IAAI,CAAC,gBAAmE,CAAC;QACnG,OAAO,gBAAgB,CAAC,IAAI,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;IACnD,CAAC;IAEM,qCAAS,GAAhB,UAA0F,MAAe,EAAE,WAAoB,EAAE,EAAiE;QAC9L,IAAM,gBAAgB,GAAI,IAAI,CAAC,gBAAmE,CAAC;QACnG,gBAAgB,CAAC,SAAS,CAAC,WAAW,EAAE,EAAE,CAAC,CAAC;IAChD,CAAC;IAEM,wCAAY,GAAnB,UAA2B,EAA4C;QACnE,IAAI,CAAC,gBAAgB,CAAC,YAAY,CAAC,UAAA,IAAI,IAAI,OAAA,EAAE,CAAC,IAAwC,CAAC,EAA5C,CAA4C,CAAC,CAAC;IAC7F,CAAC;IAEM,0CAAc,GAArB,UAAsB,EAA+D;QACjF,IAAI,CAAC,gBAAgB,CAAC,cAAc,CAAC,UAAA,IAAI,IAAI,OAAA,EAAE,CAAC,IAAgD,CAAC,EAApD,CAAoD,CAAC,CAAC;IACvG,CAAC;IACM,mCAAO,GAAd;QACI,IAAI,CAAC,gBAAgB,CAAC,OAAO,EAAE,CAAC;IACpC,CAAC;IACL,wBAAC;AAAD,CAAC,AA3BD,IA2BC;AA3BY,8CAAiB","sourcesContent":["import { ISocket } from \"./socket/iSocket\";\nimport { ISocketPackage, StructuredMessageTypeDict, StructuredSocket } from \"./socket/structuredSocket\";\n\nclass WindowSocket implements ISocket {\n    public OnMessageWithDirectObject = true;\n    private messageHandler: (ev: MessageEvent) => void;\n\n    private targetWindow: Window;\n    constructor(targetWindow: Window) {\n        this.targetWindow = targetWindow;\n        window.addEventListener(\"message\", this.messageHandler = (ev) => {\n            if (ev.source != <any>targetWindow) {\n                return;\n            }\n            this.OnMessage?.(ev.data);\n        })\n    }\n    Send(packet: string | object): void {\n        this.targetWindow.postMessage(packet, \"*\");\n    }\n    OnMessage?: ((data: any) => void) | undefined;\n    public destroy() {\n        window.removeEventListener(\"message\", this.messageHandler);\n        this.OnMessage = undefined;\n    }\n}\n\n\ntype MM<MesTypes extends Record<string, StructuredMessageTypeDict>, T extends keyof MesTypes> = keyof MesTypes[T];\nexport type MessageTypes<MesTypes extends Record<string, StructuredMessageTypeDict>, T extends keyof MesTypes> = MesTypes[T][MM<MesTypes, T>];\nexport type FrameCommunicatorSendOptionsType = {\n    replyId?: string | undefined;\n} & ({\n    awaitResponse: true;\n    awaitTime: number;\n} | {\n    awaitResponse?: false | undefined;\n});\nexport class FrameCommunicator<MesTypes extends Record<string, StructuredMessageTypeDict>> {\n    private structuredSocket: StructuredSocket<MesTypes[keyof MesTypes]>;\n    private windowSocket: WindowSocket;\n    constructor(targetWindow: Window) {\n        this.windowSocket = new WindowSocket(targetWindow);\n        this.structuredSocket = new StructuredSocket(this.windowSocket);\n    }\n    public Send<TModule extends keyof MesTypes, ReqType extends keyof MesTypes[TModule]>(target: TModule, messageType: ReqType, message: MesTypes[TModule][ReqType], options: FrameCommunicatorSendOptionsType) {\n        const structuredSocket = (this.structuredSocket as unknown as StructuredSocket<MesTypes[TModule]>);\n        return structuredSocket.Send(message, options);\n    }\n\n    public Subscribe<TModule extends keyof MesTypes, ReqType extends keyof MesTypes[TModule]>(target: TModule, messageType: ReqType, cb: (message: ISocketPackage<MesTypes[TModule][ReqType]>) => void) {\n        const structuredSocket = (this.structuredSocket as unknown as StructuredSocket<MesTypes[TModule]>);\n        structuredSocket.Subscribe(messageType, cb);\n    }\n\n    public SubscribeAll<Types>(cb: (message: ISocketPackage<Types>) => void) {\n        this.structuredSocket.SubscribeAll(data => cb(data as unknown as ISocketPackage<Types>));\n    }\n\n    public UnsubscribeAll(cb: (message: ISocketPackage<MesTypes[string][string]>) => void) {\n        this.structuredSocket.UnsubscribeAll(data => cb(data as ISocketPackage<MesTypes[string][string]>));\n    }\n    public destroy() {\n        this.structuredSocket.destroy();\n    }\n}"]}