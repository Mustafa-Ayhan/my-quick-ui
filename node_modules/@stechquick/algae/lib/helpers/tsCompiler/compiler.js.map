{"version":3,"file":"compiler.js","sourceRoot":"","sources":["../../../src/helpers/tsCompiler/compiler.ts"],"names":[],"mappings":"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","sourcesContent":["import { CompilerOptions } from \"typescript\";\nimport { Logger, LogLevel } from \"../logger\";\nimport { JSLoader } from \"./JSLoader\";\nimport Compile from \"./tsCompiler\"\n\ntype ScriptLang = \"QS\" | \"JS\" | \"TS\" | \"FL\" | \"GUI\";\ninterface ILangDTS {\n    body?: string,\n    error?: string\n};\nexport interface IScriptWithParam {\n    script: string,\n    params?: string,\n    lang: ScriptLang,\n    assigner: (compiledCode: string) => void,\n    errorHandler: (err: any) => void,\n    errors?: Array<any>,\n    name: string,\n}\nexport interface IArgumentPim {\n    Name: string,\n    Desc?: string | null,\n    Type?: ITypePim;\n    Options?: Array<IValuesPim> | string[]\n    Multiple?: boolean\n}\nexport interface IValuesPim {\n    Name: string,\n    Value: any\n}\n\nexport type ITypePim = StringConstructor | BooleanConstructor | NumberConstructor | ObjectConstructor | FunctionConstructor | ArrayConstructor | undefined | null | string;\nexport class CommonTSCompiler {\n    private static loadingProm: Promise<void> | undefined;\n    private static loadedDTSs: Record<string, ILangDTS | undefined> = {};\n    // private static dTSs: Record<string, ILangDTS> | undefined;\n    private static async LazyLoadTsCompiler(typescriptServicesURL: string) {\n        this.loadingProm = this.loadingProm || new Promise<void>((res, rej) => {\n            new JSLoader(typescriptServicesURL, () => { this.loadingProm = undefined; res(); }, (err: any) => { this.loadingProm = undefined; rej(err) }, 1).LoadJS();\n        });\n        return this.loadingProm;\n    };\n    public static async Compiler(options: Array<IScriptWithParam>, compilerData: Record<string, string>, typescriptServicesURL: string, gmEditMode?: boolean, targetVersion?: keyof typeof ts.ScriptTarget, moduleVersion?: keyof typeof ts.ModuleKind) {\n        const dtsProm = <Promise<Record<string, ILangDTS>>>this.LoadAndCacheDTSs(typescriptServicesURL);\n        if (!window.ts) { await this.LazyLoadTsCompiler(typescriptServicesURL); }\n        const dtsList = await dtsProm;\n        const errors = Object.keys(dtsList).map(dtsName => dtsList[dtsName].error).filter(error => error);\n        if (errors.length > 0) { throw (errors); }\n\n        const nameIndexedOptions = options.reduce<Record<string, IScriptWithParam>>((prev, cur) => { prev[cur.name] = cur; return prev; }, {});\n        const fss = options.map(option => ({ name: option.name, body: this.GenerateParamsIntelli(option.params) + \"; \" + option.script }));\n        Object.keys(dtsList).forEach(dtsKey => fss.push({ name: dtsKey, body: dtsList![dtsKey].body! }));\n        Object.keys(compilerData).forEach(dtsKey => fss.push({ name: dtsKey, body: compilerData[dtsKey] }));\n        const compRes = Compile(fss, (this.TypescriptCompilerOptions( window.ts, gmEditMode, targetVersion, moduleVersion)) as CompilerOptions);\n\n        Object.keys(compRes).forEach(fileName => {\n            const cur = compRes[fileName];\n            if (!cur.diagnostic) { return; }\n            if (nameIndexedOptions[cur.name]) {\n                nameIndexedOptions[cur.name].errors = cur.diagnostic;\n            }\n        });\n        return { options, compRes };\n    }\n    private static FetchModuleBody(url: string) {\n        return new Promise<{ body: string, status: number }>((res, rej) => fetch(url).then((response: any) => response.text().then((body: any) => res({ body, status: response.status })).catch(rej)).catch(rej));\n    }\n    public static async LoadAndCacheDTSs(typescriptServicesURL: string) {\n        typescriptServicesURL = typescriptServicesURL.replace(/\\/[\\d.]+\\/typescriptServices\\.js$/, \"\");\n        const items = [`${typescriptServicesURL}/lib/lib.es5.d.ts`, `${typescriptServicesURL}/lib/lib.es2015.symbol.d.ts`,\n            `${typescriptServicesURL}/lib/lib.es2015.symbol.wellknown.d.ts`, `${typescriptServicesURL}/lib/lib.es2020.bigint.d.ts`, \n            `${typescriptServicesURL}/lib/lib.es2015.promise.d.ts`, `${typescriptServicesURL}/lib/lib.es2017.string.d.ts`, `${typescriptServicesURL}/lib/lib.es2015.core.d.ts`];\n        const leftItems = items.filter(item => !this.loadedDTSs[item] || this.loadedDTSs[item]?.error);\n        if (leftItems.length <= 0) { return this.loadedDTSs; }\n        const proms = leftItems.map(item => this.FetchModuleBody(item));\n        const files = await Promise.all(proms);\n        files.forEach((file, i) => {\n            this.loadedDTSs[leftItems[i]] = (file.status == 200 && file.body) ? { body: file.body } : { error: file.status.toString() };\n            if (file.status != 200) { Logger.log({ message: `file load failed ${leftItems[i]}: ${file.status}`, error: this.loadedDTSs[leftItems[i]]?.error, level: LogLevel.error }); };\n        });\n        return this.loadedDTSs;\n    }\n    private static GenerateParamsIntelli(params?: Array<IArgumentPim> | string): string {\n        if (!params) { return \"\"; }\n        if (!(params instanceof Array)) { return params.split(\",\").map(param => \"declare var \" + param).join(\";\\n\"); }\n        return params.map(param => `declare var ${param.Name}: ${this.PropTypeToTs(param.Type)};`).join(\"\\n\");\n    }\n    private static PropTypeToTs(type: StringConstructor | BooleanConstructor | NumberConstructor | ObjectConstructor | FunctionConstructor | undefined | null | string | {}, usage: \"prop\" | \"retVal\" = \"prop\") {\n        const lookup: Record<any, string> = {}; lookup[<any>Boolean] = \"boolean\"; lookup[<any>String] = \"string\"; lookup[<any>Number] = \"number\"; lookup[<any>Object] = \"object\"; lookup[<any>Array] = \"Array<any>\"; lookup[<any>Function] = \"Function\"; lookup[<any>undefined] = \"any\"; lookup[<any>null] = \"any\";\n        if (usage == \"retVal\") {\n            lookup[<any>undefined] = \"void\"; lookup[<any>null] = \"void\";\n        }\n        return lookup[<any>type] ?? type;\n    }\n\n    private static TypescriptCompilerOptions<T extends ts.CompilerOptions>(tsInst?: typeof ts, gmEditMode?: boolean, targetVersion?: keyof typeof ts.ScriptTarget, moduleVersion?: keyof typeof ts.ModuleKind): T {\n        const target = tsInst ? tsInst.ScriptTarget[targetVersion || 'ES5'] : 1;\n        const module = tsInst && moduleVersion ? tsInst.ModuleKind[moduleVersion] : undefined;\n        const x: ts.CompilerOptions = {\n            noLib: true,\n            target,\n            module,\n            allowNonTsExtensions: true,\n            strict: false,\n            noImplicitUseStrict: true,\n            inlineSources: gmEditMode,\n            inlineSourceMap: gmEditMode\n        }\n        return <T>x;\n    };\n}\n\n\n"]}