{"version":3,"file":"hook.js","sourceRoot":"","sources":["../../src/helpers/hook.ts"],"names":[],"mappings":"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","sourcesContent":["import \"../polyfill/string\";\n\ntype HookCallBack = (...args: any) => (void | Promise<void>);\ninterface IHookLogger {\n    log: (options: { message: string, error?: Error }) => void;\n}\nexport class Hook<T extends HookCallBack>{\n    private static logger: IHookLogger;\n    public static configure(logger: IHookLogger) { Hook.logger = logger; }\n\n\n    private subscribers: Array<T> = [];\n    private postSubscribers?: Hook<T>;\n    private hookName: string;\n    private hookState: { triggered: boolean, triggerArgs: Array<any>, active: boolean }; //having a hookState states this hook manages state\n    private triggerPostSubscribersWithCb: boolean;\n\n    public get TriggerPostSubscribersWithCb(): boolean {\n        return this.triggerPostSubscribersWithCb;\n    }\n    public set TriggerPostSubscribersWithCb(v: boolean) {\n        this.triggerPostSubscribersWithCb = v;\n    }\n\n\n    constructor(hookName: string, options: { manageState?: boolean, triggerPostSubscribersWithCb?: boolean } = {}) {\n        this.hookName = hookName;\n        this.triggerPostSubscribersWithCb = options.triggerPostSubscribersWithCb || false;\n        options.manageState = options.manageState || false;\n        this.hookState = { triggered: false, triggerArgs: [], active: options.manageState };\n    }\n\n    public ResetAndStartState() {\n        this.hookState.triggerArgs = [];\n        this.hookState.active = true;\n        this.hookState.triggered = false;\n    }\n\n    public DisableState() {\n        this.hookState.triggerArgs = [];\n        this.hookState.active = false;\n        this.hookState.triggered = false;\n    }\n\n    public IsTriggered() {\n        if (!this.hookState.active) { throw new Error(\"IsTriggered can not be checked on a non manageState Hook: \" + this.hookName); }\n\n        return this.hookState.triggered;\n    }\n\n    private getHookName() {\n        let retVal = this.hookName;\n\n        if (!retVal.toLowerCase().endsWith(\"hook\")) {\n            retVal += \" hook\";\n        }\n        return retVal;\n    }\n\n    public get hasSubscribers() {\n        return this.subscriberCount > 0;\n    }\n\n    public get subscriberCount() {\n        return this.subscribers.length;\n    }\n\n    public get hasPostSubscribers(): boolean {\n        return (this.postSubscribers?.hasPostSubscribers || this.postSubscribers?.hasSubscribers) === true;\n    }\n\n    public get triggerer(): T {\n        return this.trigger as T;\n    }\n\n    private trigger(...args: Array<any>) {\n        if (this.hookState.active) {\n            this.hookState.triggered = true;\n            this.hookState.triggerArgs = args;\n        }\n        this.subscribers.forEach(sub => this.tryTriggerSubscriber(sub, args));\n        if (!this.triggerPostSubscribersWithCb) this.postSubscribers?.triggerer.apply(this.postSubscribers, args)\n    }\n\n    private async tryTriggerSubscriber(sub: T, args: Array<any>) {\n        try {\n            await sub.apply(null, args)\n        } catch (ex) {\n            const message = `${this.getHookName()} subscriber failed`;\n            if (Hook.logger) { Hook.logger.log({ error: ex as Error, message }); return; }\n            console.error(message, ex);\n        }\n    }\n\n    public triggerPostSubscribers(...args: Array<any>) {\n        this.postSubscribers?.triggerer.apply(this.postSubscribers, args);\n    }\n\n    public postSubscribe(cb: T) {\n        if (!this.postSubscribers) {\n            this.postSubscribers = new Hook<T>(this.hookName + \"_Post\", { manageState: this.hookState.active });\n            this.postSubscribers.hookState = this.hookState;\n        }\n        this.postSubscribers.subscribe(cb);\n    }\n    public postUnsubscribe(cb: T) {\n        this.postSubscribers?.unsubscribe(cb);\n    }\n    public clearPostSubscribers(forced: boolean = false) {\n        this.postSubscribers?.clearSubscribers();\n        if (forced || !this.hasPostSubscribers) {\n            this.postSubscribers = undefined;\n        }\n    }\n\n    public forceClearAllSubscibers() {\n        this.clearPostSubscribers(true);\n        this.clearSubscribers();\n    }\n\n    public subscribe(cb: T) {\n        this.subscribers.push(cb);\n        this.hookState.active && this.hookState.triggered && this.tryTriggerSubscriber(cb, this.hookState.triggerArgs);\n    }\n\n    public clearSubscribers() {\n        this.subscribers = [];\n    }\n\n    public unsubscribe(cb: T) {\n        this.subscribers = this.subscribers.filter(sub => sub != cb); // splice is fastest but this is safest, because of immutability, because of forEach traversals\n    }\n}"]}