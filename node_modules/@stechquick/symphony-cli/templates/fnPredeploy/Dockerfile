FROM fnproject/node:dev as build-stage
WORKDIR /function
COPY package.json /function/
# COPY .npmrc /function/
# COPY .npmrc /root/
COPY *.ts /function/
COPY tsconfig.json /function/
# RUN npm install
COPY node_modules/ /function/node_modules/
RUN npm run build -- --skipversion
RUN rm -rf node_modules/typescript

FROM fnproject/node
WORKDIR /function
COPY . /function/
COPY --from=build-stage /function/node_modules/ /function/node_modules/
COPY --from=build-stage /function/dist/ /function/dist/
RUN chmod -R o+r /function

# set node_env
{{environmentalVars}}
ENTRYPOINT ["node", "./dist/{{funcName}}.js"]
