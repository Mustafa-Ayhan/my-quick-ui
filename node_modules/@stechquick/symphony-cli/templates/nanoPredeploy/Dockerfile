FROM node:15.11.0-alpine as build-stage
WORKDIR /app 
COPY package.json /app/
COPY tsconfig.json /app/
# COPY .npmrc /app/
# RUN npm install
COPY functions/ /app/functions
COPY sym-functions-common/ /app/sym-functions-common
COPY sym-engine/ /app/sym-engine
COPY ./local.ts /app/
COPY node_modules/ /app/node_modules/
RUN npm run build -- --skipversion
RUN rm -rf /app/node_modules/typescript

FROM node:15.11.0-alpine
WORKDIR /app
COPY --from=build-stage /app/functions /app/functions
COPY --from=build-stage /app/sym-functions-common /app/sym-functions-common
COPY --from=build-stage /app/sym-engine /app/sym-engine
COPY --from=build-stage /app/package.json /app/
COPY --from=build-stage /app/node_modules/ /app/node_modules/
COPY --from=build-stage /app/dist/ /app/dist/
RUN chmod -R o+r /app

# set node_env
{{environmentalVars}}
ENTRYPOINT ["node", "./dist/local.js", "{\"httpPort\":3003}"]