"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ShellHelper = void 0;
const child_process_1 = require("child_process");
const log_1 = require("@stechquick/symphony-common/lib/log");
const chalk_1 = require("./chalk");
class ShellHelper {
    static ExecuteCommand(command, args, options) {
        return new Promise((res, rej) => {
            const process = child_process_1.spawn(command, args);
            process.stdout.on("data", (chunk) => {
                var _a;
                const chunkstring = chunk.toString();
                if (((_a = options === null || options === void 0 ? void 0 : options.stdout) === null || _a === void 0 ? void 0 : _a.call(options, chunkstring)) === false) {
                    return;
                }
                log_1.Logger.log({ message: chunk.toString() });
            });
            process.stderr.on("data", (chunk) => {
                var _a;
                const chunkstring = chunk.toString();
                if (((_a = options === null || options === void 0 ? void 0 : options.stderr) === null || _a === void 0 ? void 0 : _a.call(options, chunkstring)) === false) {
                    return;
                }
                log_1.Logger.log({ message: chalk_1.Chalk.create("red.bold", chunkstring) });
            });
            const exitHandler = (exit) => (code, signal) => {
                var _a;
                const exitOverride = (_a = options === null || options === void 0 ? void 0 : options.exit) === null || _a === void 0 ? void 0 : _a.call(options, code, signal);
                if (exitOverride) {
                    code = exitOverride.code;
                    signal = exitOverride.signal;
                }
                if (code) {
                    if (!(options === null || options === void 0 ? void 0 : options.noExitCode)) {
                        console.error(`${exit ? "exited" : "closed"} with: `, code, signal);
                    }
                    rej(code);
                    return;
                }
                res();
            };
            process.on("exit", exitHandler(true));
            // process.on("close", exitHandler(false));
            process.on("disconnect", () => {
                console.error("-----disconnect");
                rej("------disconnect");
            });
        });
    }
}
exports.ShellHelper = ShellHelper;
