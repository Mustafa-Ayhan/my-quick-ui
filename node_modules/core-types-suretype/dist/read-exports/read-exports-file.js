import { getValidatorSchema, extractJsonSchema, ensureNamed, } from "suretype";
import { serializeError } from './types.js';
export async function readExportedSchemas(filename, refMethod, onTopLevelNameConflict) {
    const ret = [];
    let mod;
    try {
        mod = await import(filename);
    }
    catch (err) {
        return {
            ok: false,
            error: serializeError(err),
        };
    }
    if (Array.isArray(mod)) {
        ret.push(...mod.map((value) => ({ value })));
    }
    else if (mod && typeof mod === "object") {
        Object
            .keys(mod)
            .filter(key => !["default", "__esModule"].includes(key))
            .forEach(key => {
            ret.push({ name: key, value: mod[key] });
        });
        if (mod.__esModule && mod.default) {
            if (Array.isArray(mod.default))
                ret.push(...mod.default.map((value) => ({ value })));
            else if (typeof mod.default === "object")
                Object
                    .keys(mod.default)
                    .forEach(key => {
                    ret.push({ name: key, value: mod.default[key] });
                });
        }
    }
    const schemas = ret
        .map(({ value, name }) => ({ name, schema: getValidatorSchema(value) }))
        .map(({ name, schema }) => name && schema
        ? ensureNamed(name, schema)
        : schema)
        .filter((value) => !!value);
    const { schema: jsonSchema } = extractJsonSchema(schemas, {
        onNonSuretypeValidator: 'ignore',
        onTopLevelNameConflict,
        refMethod,
    });
    return { ok: true, jsonSchema };
}
